angular.module("kel.ui",[]).directive("kelAjaxCombobox",["$document","$timeout","$q",function(l,m,n){return{restrict:"E",templateUrl:"Content/kel-ajax-combobox.html",scope:{ngModel:"=",userInput:"=",resultGetter:"=",resultList:"=",resultTotalRows:"=",selectedText:"=",selectedValue:"=",width:"="},link:function(f,p,r){function g(){1<a.pageNumber?(--a.pageNumber,d()):0<a.highlightedRow&&(a.highlightedRow=0)}function e(){a.pageNumber<a.totalPage?(++a.pageNumber,d()):a.highlightedRow<a.resultList.length-
1&&(a.highlightedRow=a.resultList.length-1)}function d(){a.fetchDone=!1;var b=null,b=a.isFromDropdown?null:a.userInput;n.all([a.resultGetter({userInput:b,pageNumber:a.pageNumber}).$promise]).then(function(b){a.$watch("resultTotalRows",function(b,c){a.fetchDone=!0;a.totalPage=Math.ceil(a.resultTotalRows/10);a.highlightedRow>a.resultList.length-1&&(a.highlightedRow=a.resultList.length-1)})})}function h(){null==a.highlightedRow?a.userInput=a.oldUserInput:0<=a.highlightedRow&&a.highlightedRow<=a.resultList.length-
1?a.selectRow(a.resultList[a.highlightedRow]):a.userInput=a.oldUserInput}function q(){m(function(){k.find("input")[0].focus()},0)}var a=f;f=(new Date).getTime();a.uxUnique="um"+f;a.pageNumber=1;a.fetchDone=!1;a.isFromDropdown=null;a.highlightedRow=null;a.oldUserInput=a.userInput;a.totalPage=0;var k=angular.element(p).find("div");angular.element(k[3]).bind("mousewheel DOMMouseScroll",function(b){var c=null;"mousewheel"==b.type?c=-1*b.wheelDelta:"DOMMouseScroll"==b.type&&(c=40*b.detail);c&&(b.preventDefault(),
0>c&&1<a.pageNumber?--a.pageNumber:0<c&&++a.pageNumber,a.fetchDone&&d())});a.goToPreviousPage=g;a.goToNextPage=e;a.goToNextSegment=function(){var b=Math.ceil(a.resultTotalRows/100);a.pageNumber+b<a.totalPage?(a.pageNumber+=b,d()):e()};a.goToPreviousSegment=function(){var b=Math.ceil(a.resultTotalRows/100);0<a.pageNumber-b?(a.pageNumber-=b,d()):e()};a.setHighlightedRow=function(b){a.highlightedRow=b};a.navigateByKey=function(b){(115==b.which||b.altKey&&40==b.which)&&a.dropdown();40==b.which?null==
a.highlightedRow?a.highlightedRow=0:(a.highlightedRow+1==a.resultList.length?a.pageNumber<a.totalPage&&(a.highlightedRow=0,e()):++a.highlightedRow,b.preventDefault()):38==b.which?null==a.highlightedRow?a.highlightedRow=9:(-1==a.highlightedRow-1?1<a.pageNumber&&g():--a.highlightedRow,b.preventDefault()):33==b.which?(a.isShowList&&b.preventDefault(),a.fetchDone&&g()):34==b.which&&a.fetchDone?(a.isShowList&&b.preventDefault(),a.fetchDone&&e()):13==b.which&&a.isShowList?(h(),b.preventDefault()):27==b.which?
(b.preventDefault(),a.userInput=a.oldUserInput,a.isShowList=!1):9==b.which&&(""==a.userInput?(a.ngModel=null,a.userInput="",a.oldUserInput=""):a.isShowList&&h(),a.isShowList=!1)};a.closePopup=function(){a.isShowList=!1};a.search=function(){a.isShowList=!0;a.pageNumber=1;a.isFromDropdown=!1;d()};a.selectRow=function(b){a.ngModel=b[a.selectedValue];a.userInput=b[a.selectedText];a.oldUserInput=a.userInput;a.isShowList=!1;a.highlightedRow=0};a.dropdown=function(){a.isShowList=!a.isShowList;a.isShowList&&
(a.pageNumber=1,a.isFromDropdown=!0,d())};l.bind("click",function(b){isChildOfComboBox=!1;b=angular.element(b.target);for(var c=0;20>c;++c){if(b.hasClass(a.uxUnique)){isChildOfComboBox=!0;break}b=b.parent()}isChildOfComboBox?q():(a.closePopup(),a.$apply())})}}}]);